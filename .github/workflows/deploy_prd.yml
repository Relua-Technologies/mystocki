name: Deploy to Production

on:
  push:
    branches:
      - 'release/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: ${{ github.ref }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Configure SSH access
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

    - name: Install Docker + Compose + Buildx (Amazon Linux)
      run: |
        ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} "
          sudo yum clean all &&
          sudo yum update -y --skip-broken &&
          sudo yum install -y docker || true &&
          sudo systemctl start docker &&
          sudo systemctl enable docker &&
          sudo usermod -aG docker ec2-user &&

          # Instalar Docker Compose (última versão)
          COMPOSE_VERSION=\$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep tag_name | cut -d '\"' -f4) &&
          sudo curl -L \"https://github.com/docker/compose/releases/download/\$COMPOSE_VERSION/docker-compose-linux-aarch64\" -o /usr/local/bin/docker-compose &&
          sudo chmod +x /usr/local/bin/docker-compose &&
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose &&

          # Instalar Buildx (última versão)
          BUILDX_VERSION=\$(curl -s https://api.github.com/repos/docker/buildx/releases/latest | grep tag_name | cut -d '\"' -f4) &&
          sudo mkdir -p ~/.docker/cli-plugins &&
          sudo curl -L \"https://github.com/docker/buildx/releases/download/\$BUILDX_VERSION/buildx-\$BUILDX_VERSION.linux-arm64\" -o /usr/libexec/docker/cli-plugins/docker-buildx &&
          sudo chmod +x /usr/libexec/docker/cli-plugins/docker-buildx &&

          # Confirmar versões
          docker --version &&
          docker-compose --version &&
          docker buildx version
        "


    - name: Clean previous deployment (safe - keep database data)
      run: |
        ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} "
          mkdir -p /home/ec2-user/mystocki &&
          cd /home/ec2-user/mystocki &&
          docker compose down || true &&
          find /home/ec2-user/mystocki -mindepth 1 -maxdepth 1 ! -name 'db_data' -exec rm -rf {} +
        "

    - name: Upload project to EC2
      run: |
        echo "Creating temporary package directory..."
        mkdir -p /tmp/package
        echo "Compressing project..."
        tar -czf /tmp/package/mystocki.tar.gz --exclude='.git' --exclude='.github' .
        echo "Uploading to EC2..."
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa /tmp/package/mystocki.tar.gz ec2-user@${{ secrets.EC2_PUBLIC_IP }}:/home/ec2-user/
        echo "Extracting on EC2..."
        ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} "
          mkdir -p /home/ec2-user/mystocki &&
          tar -xzf /home/ec2-user/mystocki.tar.gz -C /home/ec2-user/mystocki &&
          rm /home/ec2-user/mystocki.tar.gz
        "

    - name: Generate and upload .env
      run: |
        echo "" > .env
        echo '${{ toJson(secrets) }}' | jq -r 'to_entries | map(select(.key != "SSH_PRIVATE_KEY" and .key != "github_token")) | .[] | "\(.key)=\(.value)"' >> .env
        echo '${{ toJson(vars) }}' | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' >> .env

        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa .env ec2-user@${{ secrets.EC2_PUBLIC_IP }}:/home/ec2-user/mystocki/.env

    - name: Start Docker Compose
      run: |
        ssh ec2-user@${{ secrets.EC2_PUBLIC_IP }} "
          cd /home/ec2-user/mystocki &&
          docker-compose up -d --build
        "
